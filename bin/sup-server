#!/usr/bin/env ruby

require 'uri'
require 'rubygems'
require 'trollop'
require "sup"
require "sup/server"
require "sup/storage"

opts = Trollop::options do
  version "sup-server (sup #{Redwood::VERSION})"
  banner <<EOS
Usage:
  sup-server [options]
EOS
  text <<EOS

Other options:
EOS
  opt :verbose, "Increase verbosity."
  opt :version, "Show version information", :short => :none
end

Redwood::start
index = Redwood::Index.new

store_filename = 'storage'
store = Redwood::Storage.new store_filename

#index.lock_interactively or exit
begin
  index.load

  server = Redwood::Server.new index, store
  srv = TCPServer.new 'localhost', Redwood::Wire::DEFAULT_TCP_PORT
  while (s = srv.accept)
    Thread.new { server.service Redwood::Wire.new(s) }
  end

  index.save
rescue Exception => e
  File.open("sup-exception-log.txt", "w") { |f| f.puts e.backtrace }
  raise
ensure
  Redwood::finish
  #index.unlock
end
