#!/usr/bin/env ruby
# encoding: utf-8

require 'rubygems'
require 'trollop'
require "sup/server"

opts = Trollop::options do
  version "sup-server (sup #{Redwood::VERSION})"
  banner <<EOS
Usage:
  sup-server [options]
EOS
  text <<EOS

Other options:
EOS
  opt :verbose, "Increase verbosity."
  opt :version, "Show version information", :short => :none
end

HOST = 'localhost'
PORT = Redwood::Protocol::DEFAULT_TCP_PORT

lock = Redwood::Server::IndexLock.new Redwood::Server::BASE_DIR
lock.lock_interactively or exit

begin
  store = Redwood::Server::StorageActor.spawn_link(Redwood::Server::Storage.new Redwood::Server::STORAGE_FN)
  index = Redwood::Server::IndexActor.spawn_link(Redwood::Server::Index.new Redwood::Server::INDEX_FN)
  server = Redwood::Server::Dispatcher.spawn_link index, store
  listener = Redwood::Protocol::TCPListener.listener HOST, PORT
  Redwood::Protocol::TCPListener.new server, listener

  index.save
rescue Exception => e
  File.open("sup-exception-log.txt", "w") { |f| f.puts e.backtrace }
  raise
ensure
  lock.unlock
end
